<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dental Clinic Booking</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    h2, h3 {
      color: #333;
    }

    form {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #f9f9f9;
      width: 350px;
    }

    input, textarea {
      width: 100%;
      padding: 6px;
      margin: 6px 0 12px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 3px;
    }

    #bookingForm button[type="submit"] {
      background-color: #28a745;
      color: white;
      font-weight: bold;
    }

    #bookingForm button.cancel-btn {
      background-color: #6c757d;
      color: white;
    }

    .delete-btn {
      background-color: #dc3545;
      color: white;
    }

    .edit-btn {
      background-color: #007bff;
      color: white;
    }

    .export-btn {
      background-color: #17a2b8;
      color: white;
      font-weight: bold;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      cursor: pointer;
    }

    th {
      background: #007bff;
      color: white;
    }

    th.sort-asc::after {
      content: " ‚ñ≤";
    }

    th.sort-desc::after {
      content: " ‚ñº";
    }

    tr:nth-child(even) {
      background: #f2f2f2;
    }

    #searchBox {
      margin: 10px 0;
      padding: 8px;
      width: 50%;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .filter-container {
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h2>Book an Appointment</h2>
  <form id="bookingForm">
    <label>Name:</label>
    <input type="text" id="name" required>

    <label>Phone:</label>
    <input type="text" id="phone" required>

    <label>Email:</label>
    <input type="email" id="email" required>

    <label>Message:</label>
    <textarea id="message" required></textarea>

    <button type="submit">Book Now</button>
  </form>

  <h3>All Bookings</h3>
  <input type="text" id="searchBox" placeholder="üîç Search by name, phone, or email...">

  <div class="filter-container">
    <label>Filter by Date:</label>
    <input type="date" id="dateFilter">
    <button id="exportExcel" class="export-btn">‚¨áÔ∏è Export to Excel</button>
  </div>

  <table>
    <thead>
      <tr>
        <th data-field="name">Name</th>
        <th data-field="phone">Phone</th>
        <th data-field="email">Email</th>
        <th data-field="message">Message</th>
        <th data-field="date">Date</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="bookingsTable"></tbody>
  </table>

  <!-- ‚úÖ Excel export library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    const API_URL = "http://localhost:3000";
    const form = document.getElementById("bookingForm");
    const submitBtn = form.querySelector("button");
    const searchBox = document.getElementById("searchBox");
    const dateFilter = document.getElementById("dateFilter");
    let bookingsData = [];
    let sortField = null;
    let sortOrder = "asc";

    const cancelBtn = document.createElement("button");
    cancelBtn.textContent = "Cancel Edit";
    cancelBtn.type = "button";
    cancelBtn.classList.add("cancel-btn");
    cancelBtn.style.display = "none";
    form.appendChild(cancelBtn);

    // Handle form submission
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const booking = {
        name: document.getElementById("name").value,
        phone: document.getElementById("phone").value,
        email: document.getElementById("email").value,
        message: document.getElementById("message").value
      };

      const bookingId = form.dataset.editId;

      if (bookingId) {
        await fetch(`${API_URL}/bookings/${bookingId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(booking)
        });
        alert("Booking updated successfully!");
        resetForm();
      } else {
        await fetch(`${API_URL}/book`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(booking)
        });
        alert("Booking saved successfully!");
      }

      form.reset();
      loadBookings();
    });

    cancelBtn.onclick = () => resetForm();

    function resetForm() {
      form.reset();
      form.dataset.editId = "";
      submitBtn.textContent = "Book Now";
      cancelBtn.style.display = "none";
    }

    async function loadBookings() {
      const res = await fetch(`${API_URL}/bookings`);
      bookingsData = await res.json();
      renderBookings();
    }

    function renderBookings() {
      const filter = searchBox.value.toLowerCase();
      const selectedDate = dateFilter.value; // yyyy-mm-dd

      let filtered = bookingsData.filter(b =>
        b.name.toLowerCase().includes(filter) ||
        b.phone.toLowerCase().includes(filter) ||
        b.email.toLowerCase().includes(filter)
      );

      if (selectedDate) {
        filtered = filtered.filter(b => {
          const createdAt = new Date(parseInt(b._id.substring(0,8), 16) * 1000);
          const formatted = createdAt.toISOString().split("T")[0];
          return formatted === selectedDate;
        });
      }

      if (sortField) {
        filtered.sort((a, b) => {
          let valA = a[sortField].toLowerCase();
          let valB = b[sortField].toLowerCase();
          if (valA < valB) return sortOrder === "asc" ? -1 : 1;
          if (valA > valB) return sortOrder === "asc" ? 1 : -1;
          return 0;
        });
      }

      const table = document.getElementById("bookingsTable");
      table.innerHTML = "";

      filtered.forEach(b => {
        // ‚úÖ Always use ObjectId timestamp for date
        const createdAt = new Date(parseInt(b._id.substring(0,8), 16) * 1000);
        const createdDate = createdAt.toLocaleDateString();

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${b.name}</td>
          <td>${b.phone}</td>
          <td>${b.email}</td>
          <td>${b.message}</td>
          <td>${createdDate}</td>
          <td></td>
        `;

        const actionsCell = row.querySelector("td:last-child");

        const editBtn = document.createElement("button");
        editBtn.textContent = "‚úèÔ∏è Edit";
        editBtn.classList.add("edit-btn");
        editBtn.onclick = () => {
          document.getElementById("name").value = b.name;
          document.getElementById("phone").value = b.phone;
          document.getElementById("email").value = b.email;
          document.getElementById("message").value = b.message;
          form.dataset.editId = b._id;
          submitBtn.textContent = "Update Booking";
          cancelBtn.style.display = "inline";
        };

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "‚ùå Delete";
        deleteBtn.classList.add("delete-btn");
        deleteBtn.onclick = async () => {
          if (confirm("Are you sure you want to delete this booking?")) {
            await fetch(`${API_URL}/bookings/${b._id}`, { method: "DELETE" });
            loadBookings();
          }
        };

        actionsCell.appendChild(editBtn);
        actionsCell.appendChild(deleteBtn);
        table.appendChild(row);
      });
    }

    // Search
    searchBox.addEventListener("input", renderBookings);

    // Sorting
    document.querySelectorAll("th[data-field]").forEach(th => {
      th.addEventListener("click", () => {
        const field = th.dataset.field;
        if (sortField === field) {
          sortOrder = sortOrder === "asc" ? "desc" : "asc";
        } else {
          sortField = field;
          sortOrder = "asc";
        }

        document.querySelectorAll("th").forEach(h => h.classList.remove("sort-asc", "sort-desc"));
        th.classList.add(sortOrder === "asc" ? "sort-asc" : "sort-desc");

        renderBookings();
      });
    });

    // Date filter (auto apply)
    dateFilter.addEventListener("change", renderBookings);

    // Export to Excel
    document.getElementById("exportExcel").addEventListener("click", () => {
      const table = document.getElementById("bookingsTable");
      const rows = [["Name", "Phone", "Email", "Message", "Date"]];

      for (let r of table.rows) {
        const cells = Array.from(r.cells).slice(0, 5).map(td => td.textContent);
        rows.push(cells);
      }

      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Bookings");

      const fileName = `bookings_${new Date().toISOString().split("T")[0]}.xlsx`;
      XLSX.writeFile(wb, fileName);
    });

    loadBookings();
  </script>
</body>
</html>
